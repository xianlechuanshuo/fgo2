<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="css/style.css" rel="stylesheet" />
    <style>
        .servant tr:nth-child(3) td:nth-child(odd) {
            width: 13%;
        }

        .servant tr:nth-child(3) td:nth-child(even) {
            width: 20%;
        }

        .servant tr:nth-child(1) {
            white-space: nowrap;
        }
    </style>
</head>
<body id="content" onunload="setStorage()">
    <div id="showSkillsWin" class="showSkills">
    <img src="" alt="技能图" class="skillImg">
    <a id="btnClose" class="close" href="javascript:;">☒</a>
    </div>
    <div id="divServant">
        <table class="servant">
            <tr>
                <td colspan="8">
                    <select id="ddlChooseServant">
                        <option value="-1">|----------------------请选择从者-------------------------|</option>
                    </select>
                    <label for="ckIsMaxGrail">
                        <input type="checkbox" id="ckIsMaxGrail" />圣杯MAX</label>
                    <input type="text" id="txtWord" class="search" list="dlTips" autofocus />
                    <input type="button" id="btnSearch" value="查询" />&nbsp;
                    <a href="javascript:;" id="btnShowMaterials">强化素材详情</a>&nbsp;
                    <a href="javascript:;" id="btnShowSkills">从者技能详情</a>&nbsp;
                    <a href="javascript:;" id="btnRedirectKazemai">前往理想鄉</a>&nbsp;
                    <a href="javascript:;" id="btnRedirectWiki">前往wiki</a>&nbsp;
                    <datalist id="dlTips"></datalist>
                </td>
            </tr>
            <tr>
                <td>阵营</td>
                <td><span id="spanCamp"></span></td>
                <td>属性</td>
                <td><span id="spanAttributes"></span></td>
                <td>特性</td>
                <td colspan="3"><span id="spanCharacteristics"></span></td>                
            </tr>
            <tr>
                <td>等级</td>
                <td>
                    <select id="ddlLvs">
                        <option value="-1">默认</option>
                        <option value="100">Lv.100</option>
                        <option value="99">Lv.99</option>
                        <option value="98">Lv.98</option>
                        <option value="97">Lv.97</option>
                        <option value="96">Lv.96</option>
                        <option value="95">Lv.95</option>
                        <option value="94">Lv.94</option>
                        <option value="93">Lv.93</option>
                        <option value="92">Lv.92</option>
                        <option value="91">Lv.91</option>
                        <option value="90">Lv.90</option>
                        <option value="89">Lv.89</option>
                        <option value="88">Lv.88</option>
                        <option value="87">Lv.87</option>
                        <option value="86">Lv.86</option>
                        <option value="85">Lv.85</option>
                        <option value="84">Lv.84</option>
                        <option value="83">Lv.83</option>
                        <option value="82">Lv.82</option>
                        <option value="81">Lv.81</option>
                        <option value="80">Lv.80</option>
                        <option value="79">Lv.79</option>
                        <option value="78">Lv.78</option>
                        <option value="77">Lv.77</option>
                        <option value="76">Lv.76</option>
                        <option value="75">Lv.75</option>
                        <option value="74">Lv.74</option>
                        <option value="73">Lv.73</option>
                        <option value="72">Lv.72</option>
                        <option value="71">Lv.71</option>
                        <option value="70">Lv.70</option>
                        <option value="69">Lv.69</option>
                        <option value="68">Lv.68</option>
                        <option value="67">Lv.67</option>
                        <option value="66">Lv.66</option>
                        <option value="65">Lv.65</option>
                        <option value="64">Lv.64</option>
                        <option value="63">Lv.63</option>
                        <option value="62">Lv.62</option>
                        <option value="61">Lv.61</option>
                        <option value="60">Lv.60</option>
                        <option value="59">Lv.59</option>
                        <option value="58">Lv.58</option>
                        <option value="57">Lv.57</option>
                        <option value="56">Lv.56</option>
                        <option value="55">Lv.55</option>
                        <option value="54">Lv.54</option>
                        <option value="53">Lv.53</option>
                        <option value="52">Lv.52</option>
                        <option value="51">Lv.51</option>
                        <option value="50">Lv.50</option>
                        <option value="49">Lv.49</option>
                        <option value="48">Lv.48</option>
                        <option value="47">Lv.47</option>
                        <option value="46">Lv.46</option>
                        <option value="45">Lv.45</option>
                        <option value="44">Lv.44</option>
                        <option value="43">Lv.43</option>
                        <option value="42">Lv.42</option>
                        <option value="41">Lv.41</option>
                        <option value="40">Lv.40</option>
                        <option value="39">Lv.39</option>
                        <option value="38">Lv.38</option>
                        <option value="37">Lv.37</option>
                        <option value="36">Lv.36</option>
                        <option value="35">Lv.35</option>
                        <option value="34">Lv.34</option>
                        <option value="33">Lv.33</option>
                        <option value="32">Lv.32</option>
                        <option value="31">Lv.31</option>
                        <option value="30">Lv.30</option>
                        <option value="29">Lv.29</option>
                        <option value="28">Lv.28</option>
                        <option value="27">Lv.27</option>
                        <option value="26">Lv.26</option>
                        <option value="25">Lv.25</option>
                        <option value="24">Lv.24</option>
                        <option value="23">Lv.23</option>
                        <option value="22">Lv.22</option>
                        <option value="21">Lv.21</option>
                        <option value="20">Lv.20</option>
                        <option value="19">Lv.19</option>
                        <option value="18">Lv.18</option>
                        <option value="17">Lv.17</option>
                        <option value="16">Lv.16</option>
                        <option value="15">Lv.15</option>
                        <option value="14">Lv.14</option>
                        <option value="13">Lv.13</option>
                        <option value="12">Lv.12</option>
                        <option value="11">Lv.11</option>
                        <option value="10">Lv.10</option>
                        <option value="9">Lv.9</option>
                        <option value="8">Lv.8</option>
                        <option value="7">Lv.7</option>
                        <option value="6">Lv.6</option>
                        <option value="5">Lv.5</option>
                        <option value="4">Lv.4</option>
                        <option value="3">Lv.3</option>
                        <option value="2">Lv.2</option>
                        <option value="1">Lv.1</option>
                    </select>   
                </td>
                <td>攻击力</td>
                <td>
                    <input type="number" id="txtAttack" />
                </td>
                <td>芙芙Atk</td>
                <td>
                    <input type="number" id="txtFufuAtk" value="0" />
                </td>
                <td>礼装Atk</td>
                <td>
                    <input type="number" id="txtCardAtk" value="0" />
                </td>
            </tr>

            <tr>
                <td>配卡</td>
                <td colspan="7">
                    <div id="divCards" class="cards"></div>
                </td>
            </tr>

            <tr>
                <td>首卡颜色
                </td>
                <td>
                    <select id="ddlFirstCardColor">
                        <option value="0">非红色</option>
                        <option value="0.5">红色</option>
                    </select>
                </td>
                <td>卡色</td>
                <td>
                    <select id="ddlCardColor">
                        <option value="0.8" data-type="">Quick</option>
                        <option value="1.0" data-type="">Arts</option>
                        <option value="1.5" data-type="">Buster</option>
                        <option value="1.0" data-type="ea1">Extra Attack</option>
                        <option value="1.0" data-type="ea2">Extra Attack(前3张卡同色)</option>
                    </select>
                </td>
                <td>卡位</td>
                <td>
                    <select id="ddlCardPosition">
                        <option value="1.0" data-type="">一位</option>
                        <option value="1.2" data-type="">二位</option>
                        <option value="1.4" data-type="">三位</option>
                        <option value="1.0" data-type="ea">四位(Extra Attack)</option>
                    </select>
                </td>
                <td>卡牌Buff(%)</td>
                <td>
                    <input type="number" id="txtCardBuff" value="0" />
                </td>

            </tr>
            <tr>
                <td>从者职介</td>
                <td>
                    <select id="ddlCareer">
                        <option value="1.00">Saber</option>
                        <option value="0.95">Archer</option>
                        <option value="1.05">Lancer</option>
                        <option value="1.0">Rider</option>
                        <option value="0.9">Caster</option>
                        <option value="0.9">Assassin</option>
                        <option value="1.1">Berserker</option>
                        <option value="1.1">Ruler</option>
                        <option value="1.1">Avenger</option>
                        <option value="1.0">Shielder</option>
                        <option value="1.0">MoonCancer</option>
                        <option value="1.0">Altergo</option>
                    </select>
                </td>            
                <td>职介克制</td>
                <td>
                    <select id="ddlCareerResist">
                        <option value="1.0">非克制</option>
                        <option value="2.0">普通克制</option>
                        <option value="1.5">狂阶克制</option>
                        <option value="0.5">被克制</option>
                        <option value="1.2">克制Beast III</option>
                        <option value="1.5">Altergo克制下三骑</option>
                    </select>
                </td>
                <td>阵营克制</td>
                <td>
                    <select id="ddlCampResist">
                        <option value="1.1">克制</option>
                        <option value="1.0">非克制</option>
                        <option value="0.9">被克制</option>
                    </select>
                </td>
                <td>攻击力Buff(%)</td>
                <td>
                    <input type="number" id="txtAttackBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>敌方防御力Buff(%)</td>
                <td>
                    <input type="number" id="txtEnemyDefenceBuff" value="0" />
                </td>
                <td>敌方特防威力Buff(%)</td>
                <td>
                    <input type="number" id="txtSpecialDefencePowerBuff" value="0" />
                </td>
                <td>固定伤害Buff</td>
                <td>
                    <input type="number" id="txtFixedDamageBuff" value="0" />
                </td> 
                <td>敌方固定减伤Buff</td>
                <td>
                    <input type="number" id="txtEnemyFixedDamageReductionBuff" value="0" />
                </td>                               
            </tr>
            <tr>
                <td>特攻威力Buff(%)</td>
                <td>
                    <input type="number" id="txtSpecialAttackPowerBuff" value="0" />
                </td>
                <td colspan="2" style="text-align: center">
                    <label for="ckIsBusterChain">Buster Chain加成<input type="checkbox" id="ckIsBusterChain" /></label></td>
                <td  colspan="2" style="text-align: center">
                    <label for="ckIsCritical">暴击<input type="checkbox" id="ckIsCritical" /></label>

                </td>
                <td>暴击威力Buff(%)</td>
                <td >
                    <input type="number" id="txtCritialPowerBuff" value="0" data-value="0" /></td>

            </tr>
            <tr>
                <td colspan="8">
                    <input type="button" value="计算" id="btnCalcute" onclick="calc()" />
                    <label for="ckIsCalcTotal">计算总伤害<input type="checkbox" id="ckIsCalcTotal" /></label>
                </td>
            </tr>
        </table>
    </div>
    <br />

    <div id="divResult" class="resultWrapper">
        <b>结果：<a href="javascript:;" onclick="clearTable(1)">清空</a></b>
        <table id="tbResult" class="result">
            <tr>
                <th>排名</th>
                <th>从者</th>
                <th>等级</th>
                <th>ATK</th>
                <th>阵营克制</th>
                <th>首卡颜色</th>
                <th>卡色</th>
                <th>卡位</th>
                <th>卡牌Buff</th>
                <th>攻击力Buff</th>
                <th>特攻威力Buff</th>
                <th>敌方防御力Buff</th>
                <th>Buster Chain</th>
                <th>暴击</th>
                <th>暴击威力Buff</th>
                <th>最小值 </th>
                <th>最大值</th>
                <th>平均值</th>
                <th>&nbsp;</th>
            </tr>
        </table>
    </div>
</body>
</html>
<script src="js/lvs.js"></script>
<script src="js/data.js"></script>
<script src="js/common.js"></script>
<script src="js/base.js"></script>
<script type="text/javascript">
    /****************************************************************************/
    intialData();
    intialServantList();
    loadStorage(false);
    bindSearchTips();

    //圣杯MAX勾选框改变事件
    $("ckIsMaxGrail").onchange = function () {
        var id = $("ddlChooseServant").value;
        if (id == "-1") {
            alert("请选择从者");
            return;
        }
        var servant = servants[id];
        var check = $("ckIsMaxGrail").checked;
        if (check) {
            $("txtAttack").value = servant.maxAtk;
            $("ddlLvs").selectedIndex=1;
        }
        else {
            $("txtAttack").value = servant.atk;
            $("ddlLvs").selectedIndex=0;
        }
    }

    //下拉从者选中项发生变化事件
    $("ddlChooseServant").onchange = function () {
        $("ckIsMaxGrail").checked = false;

        $("txtCardBuff").value = 0;
        $("txtCardBuff").dataset.value = 0;

        $("txtFixedDamageBuff").value = 0;

        $("txtCritialPowerBuff").value = 0;
        $("txtCritialPowerBuff").dataset.value = 0;

        $("ckIsCritical").checked = false;
        $("txtCritialPowerBuff").disabled = true;
        $("ddlLvs").selectedIndex=0;

        var id = this.value;
        if (id != "-1" && id != "") {
            bindServantData(id);
        }
    }

    //首卡颜色选中项发生变化事件
    $("ddlFirstCardColor").onchange = function () {
        if (getDdlText("ddlCardPosition") == "一位" && getDdlText("ddlFirstCardColor") == "红色") {
            document.querySelector("#ddlCardColor option[value='1.5']").selected = true;
            $("ddlCardColor").onchange();
        }
    }

    //卡色选中项发生变化事件
    $("ddlCardColor").onchange = function () {
        var cardEnabled = false;
        if (getDdlAttrText("ddlCardColor", "type") == "ea1" || getDdlAttrText("ddlCardColor", "type") == "ea2") {
            //ex卡不吃卡牌buff
            cardEnabled = true;
            $("txtCardBuff").value = 0;

            $("ddlCardPosition").disabled = true;
            document.querySelector("#ddlCardPosition option[data-type='ea']").selected = true;

        }
        else if (getDdlText("ddlCardColor") != "Buster" && getDdlText("ddlCardPosition") == "一位") {
            $("ddlFirstCardColor").selectedIndex = 0;
        }
        else if (getDdlText("ddlCardColor") == "Buster" && getDdlText("ddlCardPosition") == "一位") {
            $("ddlFirstCardColor").selectedIndex = 1;
        }
        else {
            $("ddlCardPosition").disabled = false;
            if (getDdlAttrText("ddlCardPosition", "type") == "ea") {
                $("ddlCardPosition").selectedIndex = 0;

                if (getDdlText("ddlCardColor") != "Buster") {
                    $("ddlFirstCardColor").selectedIndex = 0;
                }
                else {
                    $("ddlFirstCardColor").selectedIndex = 1;
                }
            }
        }
        var index = parseInt($("ddlChooseServant").value);
        bindServantCareerSkillInfo(servants[index]);
        $("txtCardBuff").disabled = cardEnabled;
        if(cardEnabled){
            $("txtCardBuff").value = 0;
        }        
    }

    //卡位选中项发生变化事件
    $("ddlCardPosition").onchange = function () {
        var cardEnabled2 = false;
        if (getDdlAttrText("ddlCardPosition", "type") == "ea") {
            //ex卡不吃卡牌buff
            cardEnabled2 = true;
            $("txtCardBuff").value = 0;

            if (getDdlAttrText("ddlCardColor", "type") != "ea1" && getDdlAttrText("ddlCardColor", "type") != "ea2") {
                alert("请在卡色处选择Extra Attack");
                $("ddlCardPosition").selectedIndex = 0;
                cardEnabled2 = false;
                var index = parseInt($("ddlChooseServant").value);
                bindServantCareerSkillInfo(servants[index]);
            }

        }
        $("txtCardBuff").disabled = cardEnabled2;      
    }

    //暴击
    $("txtCritialPowerBuff").disabled = $("ckIsCritical").checked ? false : true;
    $("ckIsCritical").onchange = function () {
        if ($("ckIsCritical").checked) {//暴击
            $("txtCritialPowerBuff").disabled = false;
            $("txtCritialPowerBuff").value = getTxtAttrFloatNum("txtCritialPowerBuff", "value");
        }
        else {//不暴击
            $("txtCritialPowerBuff").disabled = true;
            $("txtCritialPowerBuff").value = 0;
        }
    }
    //等级下拉列表选中项改变事件
    $("ddlLvs").onchange=function(){
        var id=$("ddlChooseServant").value;
        if (id == "-1" || id == "") {
            return;
        }

        var servant = servants[id];  

        var lv=this.value;
        //默认【圣杯MAX】非勾选状态
        $("ckIsMaxGrail").checked=false;

        if(lv!="-1"){//非默认
            // console.log(servant.lvs[lv-1]);
            lv=servant.lvs[lv-1];
            $("txtAttack").value=lv.a;
            if(lv.a==servant.maxAtk){
                $("ckIsMaxGrail").checked=true;
                $("ckIsMaxGrail").onchange();
            }
        }
        else{//默认
            $("txtAttack").value=servant.atk; 
        }
    }

    /****************************************************************************/

    //绑定从者基本信息
    function bindServantData(id) {
        var servant = servants[id];
        //0.阵营
        //$("spanCamp").innerHTML = servant.camp;
        $("spanCamp").innerHTML = "<a href='javascript:;' data-value='@" + servant.camp + "' onclick='autoClickSearch(this)'>" + servant.camp + "</a>"

        //1.攻击力
        $("txtAttack").value = servant.atk;

        //2.从者职介
        var careers = $("ddlCareer").options;
        for (var i = 0; i < careers.length; i++) {
            var career = careers[i];
            if (career.text == servant.career) {
                career.selected = true;
            }
        }

        //3.职介技能
        bindServantCareerSkillInfo(servant);

        //4.配卡
        var cardsStr = servant.cards;
        if (cardsStr && cardsStr.length == 5) {//ABBBQ
            //用CSS精灵减少图片的http请求次数(由原来3次变成现在的1次)
            appendCards(cardsStr);
        }

        //5.属性
        bindAttributes(servant);

        //6.特性
        bindCharacteristics(servant);
    }

    //绑定从者职介信息
    function bindServantCareerSkillInfo(servant) {
        //{ cardColor: 1, cardBuff: 10, fixedDamageBuff: 0, critialPowerBuff: 0 }
        var careerSkill = servant.careerSkill;

        if (careerSkill) {
            var cardColorValue = getFloat("ddlCardColor");
            var cardBuffs = careerSkill.cardBuff;
            if (isNaN(cardBuffs)) {//"12|11"
                cardBuffs = careerSkill.cardBuff.split('|');
            }

            var cardColor = careerSkill.cardColor;


            /************************************卡牌Buff******************************************************/
            //0.8(Quick)，1(Arts)，1.5(Buster)，0(All)，-1(None)，-2(Quick和Arts)，-3(Buster和Quick)
            if ((cardColor == 0.8 || cardColor == 1 || cardColor == 1.5) && cardColor == cardColorValue) {
                $("txtCardBuff").dataset.value = careerSkill.cardBuff;

                $("txtCardBuff").value = careerSkill.cardBuff;
            }
            else if (cardColor == 0) {//215
                $("txtCardBuff").dataset.value = careerSkill.cardBuff;
                $("txtCardBuff").value = careerSkill.cardBuff;
            }
                //Quick和Arts
            else if (cardColor == -2 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                var quickBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = careerSkill.quickBuff;
                $("txtCardBuff").value = quickBuff;
            }
            else if (cardColor == -2 && cardColorValue == 1 && cardBuffs && cardBuffs.length == 2) {
                var artsBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = careerSkill.artsBuff;
                $("txtCardBuff").value = artsBuff;
            }
                //Buster和Quick
            else if (cardColor == -3 && cardColorValue == 1.5 && cardBuffs && cardBuffs.length == 2) {
                var busterBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = careerSkill.busterBuff;
                $("txtCardBuff").value = busterBuff;
            }
            else if (cardColor == -3 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                var quickBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = careerSkill.quickBuff;
                $("txtCardBuff").value = quickBuff;
            }
            else {
                $("txtCardBuff").dataset.value = 0;

                $("txtCardBuff").value = 0;
            }

            /****************************************固定伤害Buff**************************************************/
            if (!isNaN(careerSkill.fixedDamageBuff)) {
                $("txtFixedDamageBuff").value = careerSkill.fixedDamageBuff;
            }

            /****************************************暴击威力Buff**************************************************/
            if (!$("ckIsCritical").checked) {
                $("txtCritialPowerBuff").value = 0;
            }
            else {
                $("txtCritialPowerBuff").value = careerSkill.critialPowerBuff;
            }

            $("txtCritialPowerBuff").dataset.value = careerSkill.critialPowerBuff;
        }
    }

    function intialServantList() {
        for (var key in servants) {
            if (isNaN(key)) {
                return;
            }
            var item = servants[key];
            $("ddlChooseServant").options.add(new Option("【" + item.career + "】" + item.name, item.id));
        }
    }



    var resultArr = new Array();
    var rankIndex = 0;
    var guid = 0;
    //计算指令卡伤害
    function calc() {
        if ($("ddlChooseServant").value == "-1") {
            alert("请选择从者")
            return;
        }
        guid++;
        //1.攻击力
        var attack = getFloat("txtAttack");

        //2.芙芙Atk
        var fufuAtk = getFloat("txtFufuAtk");

        //3.礼装Atk
        var cardAtk = getFloat("txtCardAtk");

        attack += fufuAtk + cardAtk;

        //4.首卡颜色
        var firstCardColor = getFloat("ddlFirstCardColor");

        //5.卡色
        var cardColor = getFloat("ddlCardColor");

        //6.卡位
        var cardPostion = getFloat("ddlCardPosition");

        //7.职介克制
        var careerResist = getFloat("ddlCareerResist");

        //8.阵营克制
        var campResist = getFloat("ddlCampResist");

        //9.从者职介 
        var career = getFloat("ddlCareer");

        //10.卡牌Buff(%)
        var cardBuff = getFloat("txtCardBuff") / 100;

        //11.攻击力Buff(%)
        var attackBuff = getFloat("txtAttackBuff") / 100;

        //12.敌方防御力Buff(%)
        var enemyDefenceBuff = getFloat("txtEnemyDefenceBuff") / 100;

        //13.特攻威力Buff(%)
        var specialAttackPowerBuff = getFloat("txtSpecialAttackPowerBuff") / 100;

        //14.敌方特防威力Buff(%)
        var specialDefencePowerBuff = getFloat("txtSpecialDefencePowerBuff") / 100;

        //15.固定伤害Buff
        var fixedDamageBuff = getFloat("txtFixedDamageBuff");

        //16.敌方固定减伤Buff
        var enemyFixedDamageReductionBuff = getFloat("txtEnemyFixedDamageReductionBuff");

        //17.暴击威力BUFF
        var critialPowerBuff = getFloat("txtCritialPowerBuff") / 100;

        //18.EX攻击奖励
        var exAttackReward = 1;

        if (getDdlAttrText("ddlCardColor", "type") == "ea1") {//不同色
            exAttackReward = 2.0;
        }
        else if (getDdlAttrText("ddlCardColor", "type") == "ea2") {//同色
            exAttackReward = 3.5;
        }

        //19.Buster Chain加成
        var busterChain = 0;
        if ($("ckIsBusterChain").checked) {
            busterChain = 0.2;
        }

        //20.暴击补正：暴击时计算此项。为定值[2.0]。
        var critialCorrection = 1.0;
        if ($("ckIsCritical").checked) {
            critialCorrection = 2.0;
        }
        /*
           ATK×攻击补正(0.23)×[卡牌伤害倍率×位置加成×(1+卡牌BUFF)+首位加成]×职阶补正×职阶相性补正×阵营相性补正×乱数补正×(1+攻击力BUFF—敌方防御力BUFF—敌方特防威力BUFF)×(1+特攻威力BUFF+暴击威力BUFF)×暴击补正×EX攻击奖励
 +(固定伤害BUFF—敌方固定伤害BUFF)
 + ATK×Buster Chain加成
        */
        var resultMin = attack * 0.23 * [cardColor * cardPostion * (1 + cardBuff) + firstCardColor] * career * careerResist * campResist * 0.9 * (1 + attackBuff - enemyDefenceBuff - specialDefencePowerBuff) * (1 + specialAttackPowerBuff + critialPowerBuff) * critialCorrection * exAttackReward + (fixedDamageBuff - enemyFixedDamageReductionBuff) + attack * busterChain;
        resultMin = Math.floor(resultMin);

        var resultMax = attack * 0.23 * [cardColor * cardPostion * (1 + cardBuff) + firstCardColor] * career * careerResist * campResist * 1.1 * (1 + attackBuff - enemyDefenceBuff - specialDefencePowerBuff) * (1 + specialAttackPowerBuff + critialPowerBuff) * critialCorrection * exAttackReward + (fixedDamageBuff - enemyFixedDamageReductionBuff) + attack * busterChain;
        resultMax = Math.floor(resultMax);

        var resultAvg = Math.round((resultMin + resultMax) * 1.0 / 2);

        var servantName = getDdlText("ddlChooseServant");

        var isMaxGrail = $("ckIsMaxGrail").checked;
        if (isMaxGrail) {
            servantName = "<span class='text-gradient'>" + servantName + "</span>";
        }

        var careerResistClassName = "normal";//非克制
        if (careerResist > 1) {//克制
            careerResistClassName = "weak";
        }
        else if (careerResist < 1) {//被克制
            careerResistClassName = "resist";
        }

        var model = {
            guid: guid,
            servantName: servantName,
            lv:getDdlText("ddlLvs"),
            atk: attack,
            campResist: getDdlText("ddlCampResist"),
            firstCard: getDdlText("ddlFirstCardColor"),
            cardColor: getDdlText("ddlCardColor"),
            cardPosition: getDdlText("ddlCardPosition"),
            cardBuff: getFloat("txtCardBuff"),
            attackBuff: getFloat("txtAttackBuff"),
            specialAttackPowerBuff: getFloat("txtSpecialAttackPowerBuff"),
            enemyDefenceBuff: getFloat("txtEnemyDefenceBuff"),
            isBusterChain: $("ckIsBusterChain").checked ? "是" : "否",
            isCritial: $("ckIsCritical").checked ? "是" : "否",
            critialPowerBuff: getFloat("txtCritialPowerBuff"),
            min: resultMin,
            max: resultMax,
            avg: resultAvg,
            careerResistClassName: careerResistClassName
        };
        resultArr.push(model);
        showResult();
        reSort();
        calcTotal();
        resizeParentWindow();
    }

    //计算总伤害
    function calcTotal() {
        if (!$("ckIsCalcTotal").checked) {
            return;
        }
        if (!resultArr || resultArr.length <= 0) {
            return;
        }
        var min = 0;
        var max = 0;
        var avg = 0;
        for (var i = 0; i < resultArr.length; i++) {
            min += resultArr[i].min;
            max += resultArr[i].max;
            avg = Math.round((min + max) * 1.0 / 2);
        }

        rankIndex++;

        var tb = document.getElementById("tbResult");
        var newRow = tb.insertRow(-1);
        //1.排名
        var firstCell = newRow.insertCell(-1);
        firstCell.innerHTML = "总伤害";
        firstCell.colSpan = "15";//设置单元格跨14列
        firstCell.align = "center";//居中显示

        //14.指令卡伤害最小值
        var minCell = newRow.insertCell(-1);
        minCell.innerHTML = min;
        minCell.classList.add("normal");
        //15.指令卡伤害最大值   
        var maxCell = newRow.insertCell(-1);
        maxCell.innerHTML = max;
        maxCell.classList.add("normal");
        //16.指令卡伤害平均值     
        var avgCell = newRow.insertCell(-1);
        avgCell.innerHTML = avg;
        avgCell.classList.add("normal");
        //17.删除操作     
        newRow.insertCell(-1).innerHTML = "&nbsp;"
    }

    //从大到小重新排序
    function reSort() {
        resultArr.sort(compare("avg"));
        clearTable();
        for (var i = 0; i < resultArr.length; i++) {
            createTr(resultArr[i]);
        }
    }

    //删除指定行
    function delTr(obj, guid) {
        for (var i = 0; i < resultArr.length; i++) {
            if (resultArr[i].guid == guid) {
                resultArr.remove(i);
            }
        }
        var deleteRow = obj.parentElement.parentElement;
        deleteRow.parentElement.removeChild(deleteRow);
        reSort();
        calcTotal();
        if (!resultArr || resultArr.length <= 0) {
            hidResult();
        }

        resizeParentWindow();
    }
    //清空table
    function clearTable(obj) {
        if (obj == 1) {
            resultArr.length = 0;
            hidResult();
        }
        rankIndex = 0;
        var tb = document.getElementById("tbResult");
        var len = tb.rows.length
        for (var i = len - 1; i > 0; i--) {
            tb.deleteRow(i);
        }
        resizeParentWindow();
    }
    //新增Tr
    function createTr(obj) {
        rankIndex++;

        var tb = document.getElementById("tbResult");
        var newRow = tb.insertRow(-1);
        //1.排名
        newRow.insertCell(-1).innerHTML = rankIndex;
        //2.从者
        newRow.insertCell(-1).innerHTML = obj.servantName;
        //3.等级
        newRow.insertCell(-1).innerHTML = obj.lv;
        //4.ATK          
        newRow.insertCell(-1).innerHTML = obj.atk;
        //5.阵营克制
        newRow.insertCell(-1).innerHTML = obj.campResist;

        //6.首卡颜色
        newRow.insertCell(-1).innerHTML = obj.firstCard;
        //7.卡色
        newRow.insertCell(-1).innerHTML = obj.cardColor;
        //8.卡位
        newRow.insertCell(-1).innerHTML = obj.cardPosition;

        //9.卡牌Buff     
        newRow.insertCell(-1).innerHTML = obj.cardBuff;
        //10.攻击力Buff   
        newRow.insertCell(-1).innerHTML = obj.attackBuff;
        //11.特攻威力Buff 
        newRow.insertCell(-1).innerHTML = obj.specialAttackPowerBuff;

        //12.敌人防御力Buff    
        newRow.insertCell(-1).innerHTML = obj.enemyDefenceBuff;
        //13.Buster Chain
        newRow.insertCell(-1).innerHTML = obj.isBusterChain;
        //14.暴击
        newRow.insertCell(-1).innerHTML = obj.isCritial;
        //15.暴击威力Buff
        newRow.insertCell(-1).innerHTML = obj.critialPowerBuff;

        //16.指令卡伤害最小值
        var min = newRow.insertCell(-1);
        min.innerHTML = obj.min;
        min.classList.add(obj.careerResistClassName);
        //17.指令卡伤害最大值         
        var max = newRow.insertCell(-1);
        max.innerHTML = obj.max;
        max.classList.add(obj.careerResistClassName);
        //18.指令卡伤害平均值
        var avg = newRow.insertCell(-1);
        avg.innerHTML = obj.avg;
        avg.classList.add(obj.careerResistClassName);
        //19.删除操作     
        newRow.insertCell(-1).innerHTML = "<a href='javascript:;' onclick='delTr(this," + obj.guid + ")'>删</a>"
    }

</script>
