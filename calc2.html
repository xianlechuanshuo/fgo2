<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <style type="text/css">
        table {
            border-collapse: collapse;
            font-size: 14px;
        }

            table td {
                border: 1px solid #000;
                padding: 5px;
            }

                table td:nth-child(1) {
                    width: 150px;
                }

                table td:nth-child(2) {
                    width: 250px;
                }

            table tr:nth-child(1) td {
                text-align: center;
            }

        input[type="checkbox"] {
            vertical-align: middle;
        }
    </style>

</head>
<body>
    <div>
        <table>

            <tr>
                <td colspan="4">
                    <select id="ddlChooseServant">
                        <option value="-1">|----------------------请选择从者-------------------------|</option>
                    </select>

                </td>
            </tr>

            <tr>
                <td>攻击力</td>
                <td colspan="4">
                    <input type="text" id="txtAttack" />
                </td>
            </tr>

            <tr>
                <td>Hp最大值</td>
                <td>
                    <input type="text" id="txtMaxHp" />
                </td>
                <td>剩余Hp值</td>
                <td>
                    <input type="text" id="txtRemainHp" />
                </td>
            </tr>

            <tr>
                <td>强化芙芙Atk</td>
                <td>
                    <input type="text" id="txtFufuAtk" value="0" />
                </td>
                <td>强化芙芙Hp</td>
                <td>
                    <input type="text" id="txtFufuHp" value="0" />
                </td>
            </tr>

            <tr>
                <td>礼装Atk</td>
                <td>
                    <input type="text" id="txtCardAtk" value="0" />
                </td>
                <td>礼装Hp</td>
                <td>
                    <input type="text" id="txtCardHp" value="0" />
                </td>
            </tr>

            <tr>
                <td>宝具等级</td>
                <td>
                    <select id="ddlTreasureLevel">
                        <option value="tl1">1</option>
                        <option value="tl2">2</option>
                        <option value="tl3">3</option>
                        <option value="tl4">4</option>
                        <option value="tl5">5</option>
                    </select>
                </td>
                <td>OC等级</td>
                <td>
                    <select id="ddlOc">
                        <option value="oc1">1</option>
                        <option value="oc2">2</option>
                        <option value="oc3">3</option>
                        <option value="oc4">4</option>
                        <option value="oc5">5</option>
                    </select>
                    <label for="ckIsSpecialAttack">
                        <input type="checkbox" id="ckIsSpecialAttack" value="1" />特攻
                    </label>
                </td>
            </tr>

            <tr>
                <td>宝具倍率(%)</td>
                <td colspan="4">
                    <input type="text" id="txtTreasureRate" />
                </td>
            </tr>
            <tr>
                <td>卡色</td>
                <td colspan="4">
                    <select id="ddlCardColor">
                        <option value="0.8">Quick</option>
                        <option value="1.0">Arts</option>
                        <option value="1.5">Buster</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>职介克制</td>
                <td>
                    <select id="ddlCareerResist">
                        <option value="1.0">非克制</option>
                        <option value="2.0">普通克制</option>
                        <option value="1.5">狂阶克制</option>
                        <option value="0.5">被克制</option>
                    </select>
                </td>
                <td>阵营克制</td>
                <td>
                    <select id="ddlCampResist">
                        <option value="1.1">克制</option>
                        <option value="1.0">非克制</option>
                        <option value="0.9">被克制</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td>从者职介</td>
                <td colspan="4">
                    <select id="ddlCareer">
                        <option value="1.00">Saber</option>
                        <option value="0.95">Archer</option>
                        <option value="1.05">Lancer</option>
                        <option value="1.0">Rider</option>
                        <option value="0.9">Caster</option>
                        <option value="0.9">Assassin</option>
                        <option value="1.1">Berserker</option>
                        <option value="1.1">Ruler</option>
                        <option value="1.1">Avenger</option>
                        <option value="1.0">Shielder</option>
                    </select>
                </td>
            </tr>


            <tr>
                <td>宝具威力Buff(%)</td>
                <td colspan="4">
                    <input type="text" id="txtTreasurePowerBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>卡牌Buff(%)</td>
                <td colspan="4">
                    <input type="text" id="txtCardBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>攻击力Buff(%)</td>
                <td colspan="4">
                    <input type="text" id="txtAttackBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>敌方防御力Buff(%)</td>
                <td colspan="4">
                    <input type="text" id="txtEnemyDefenceBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>特攻威力Buff(%)</td>
                <td colspan="4">
                    <input type="text" id="txtSpecialAttackPowerBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>敌方特防威力Buff(%)</td>
                <td colspan="4">
                    <input type="text" id="txtSpecialDefencePowerBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>固定伤害Buff</td>
                <td colspan="4">
                    <input type="text" id="txtFixedDamageBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>敌方固定减伤Buff</td>
                <td colspan="4">
                    <input type="text" id="txtEnemyFixedDamageReductionBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>宝具特攻(%)</td>
                <td colspan="4">
                    <input type="text" id="txtTreasureSpecialAttack" value="100" />
                </td>
            </tr>
            <tr>
                <td colspan="4">
                    <input type="button" value="计算" id="btnCalcute" onclick="calc()" />
                </td>
            </tr>
        </table>
    </div>
</body>
</html>
<script src="data.js"></script>
<script type="text/javascript">
    window.onload = function () {
        intialData();
        intialServantList();
        //下拉从者选中项发生变化事件
        $("ddlChooseServant").onchange = function () {
            $("ckIsSpecialAttack").checked = false;
            changeOc();
            var id = this.value;
            if (id != "-1") {
                bindServantData(id);
            }
        }
        //宝具等级选中项发生变化事件
        $("ddlTreasureLevel").onchange = function () {
            changeTreasureRate();
        };

        //OC等级选中项发生变化事件
        $("ddlOc").onchange = function () {
            changeOc();
        };
        //Hp值变动事件：动态计算双子宝具倍率
        $("txtRemainHp").onchange = function () {
            changeOc();
        }
        $("txtFufuHp").onchange = function () {
            changeOc();
        }
        $("txtCardHp").onchange = function () {
            changeOc();
        }

        //是否特攻
        $("ckIsSpecialAttack").onclick = function () {
            //if (this.checked) {
            //    changeOc();
            //}
            //else {
            //    $("txtTreasureSpecialAttack").value = 100;
            //}
            changeOc();
        }

    }
    //绑定从者基本信息
    function bindServantData(id) {
        var servant = servants[id];
        //1.攻击力
        $("txtAttack").value = servant.atk;

        //2.Hp最大值、剩余Hp值
        $("txtMaxHp").value = servant.hp;
        $("txtRemainHp").value = servant.hp;

        //3.宝具倍率
        changeTreasureRate(servant);

        //4.卡色
        var cardColors = $("ddlCardColor").options;
        for (var i = 0; i < cardColors.length; i++) {
            var cardColor = cardColors[i];
            if (cardColor.value == servant.cardColor) {
                cardColor.selected = true;
            }
        }

        //5.从者职介
        var careers = $("ddlCareer").options;
        for (var i = 0; i < careers.length; i++) {
            var career = careers[i];
            if (career.text == servant.career) {
                career.selected = true;
            }
        }


        //6.OC等级
        changeOc();

    }

    //计算双子宝具总倍率
    function calTreasureSpecialRemainHpAttackRate() {
        var ocLevel = $("ddlOc").value;
        var id = $("ddlChooseServant").value;
        servant = servants[id];
        var ocs = servant.oc;
        var index = $("ddlTreasureLevel").selectedIndex;
        var tl = $("ddlTreasureLevel").options[index].value;
        //原宝具倍率
        var treasureRate = servant.tl[tl];

        //附加倍率《超蓄力威力提升》 (此倍率×自身已损失HP所占百分比,与宝具倍率加算)
        //【※总倍率＝攻击倍率+HP特攻倍率*(1—现在HP/最大HP)】
        var maxHp = getFloat("txtMaxHp");
        var fufuHp = getFloat("txtFufuHp");
        var cardHp = getFloat("txtCardHp");
        var totalHp = maxHp + fufuHp + cardHp;

        var remainHp = getFloat("txtRemainHp");
        //附加倍率
        var additionalRate = ocs[ocLevel] * (1 - remainHp / totalHp);

        //总宝具倍率
        treasureRate += additionalRate;
        //向下取整总宝具倍率
        $("txtTreasureRate").value = Math.floor(treasureRate);

    }
    //计算自爆弓宝具总倍率
    function calTreasureSpecialExplosionAttackRate() {
        var ocLevel = $("ddlOc").value;
        var id = $("ddlChooseServant").value;
        servant = servants[id];
        var ocs = servant.oc;
        var index = $("ddlTreasureLevel").selectedIndex;
        var tl = $("ddlTreasureLevel").options[index].value;
        //原宝具倍率
        var treasureRate = servant.tl[tl];

        //总宝具倍率
        treasureRate += ocs[ocLevel];
        //向下取整总宝具倍率
        $("txtTreasureRate").value = Math.floor(treasureRate);
    }

    //OC等级选中项发生变化事件
    function changeOc(servant) {
        if (!servant) {
            var id = $("ddlChooseServant").value;
            servant = servants[id];
        }

        var ocLevel = $("ddlOc").value;
        var isSpecialAttack = $("ckIsSpecialAttack");
        var ocs = servant.oc;
        if (isSpecialAttack.checked) {//是特攻
            if (ocs["type"] == "TreasureSpecialAttack") {//宝具特攻
                $("txtTreasureSpecialAttack").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasureSpecialRemainHpAttack") {//双子宝具特攻
                calTreasureSpecialRemainHpAttackRate();
            }
            else if (ocs["type"] == "TreasureSpecialExplosionAttack") {//自爆弓特攻
                calTreasureSpecialExplosionAttackRate();
            }
            else if (ocs["type"] == "SpecialAttackPowerBuff") {//杰克女性特攻
                $("txtSpecialAttackPowerBuff").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasureSpecialCardPowerAttack") {//R金时OC绿魔放
                $("txtCardBuff").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasureSpecialAtkPowerAttack") {//B兰OC加攻
                $("txtAttackBuff").value = ocs[ocLevel];
            }
        }
        else {
            $("txtTreasureSpecialAttack").value = 100;
            $("txtSpecialAttackPowerBuff").value = 0;
            $("txtCardBuff").value = 0;
            $("txtAttackBuff").value = 0;

        }
    }


    //宝具等级选中项发生变化事件
    function changeTreasureRate(servant) {
        if (!servant) {
            var id = $("ddlChooseServant").value;
            servant = servants[id];
        }
        var index = $("ddlTreasureLevel").selectedIndex;
        var tl = $("ddlTreasureLevel").options[index].value;
        var treasureRate = servant.tl[tl];
        $("txtTreasureRate").value = treasureRate;
        if (servant.oc.type == "TreasureSpecialRemainHpAttack" && $("ckIsSpecialAttack").checked) {//双子宝具特攻并且勾选了特攻
            calTreasureSpecialRemainHpAttackRate();
        }
        else if (servant.oc.type == "TreasureSpecialExplosionAttack" && $("ckIsSpecialAttack").checked) {//自爆弓特攻
            calTreasureSpecialExplosionAttackRate();
        }
    }
    function intialServantList() {
        for (var key in servants) {
            var item = servants[key];
            $("ddlChooseServant").options.add(new Option("【" + item.career + "】" + item.name, item.id));
        }
    }

    function $(id) {
        return document.getElementById(id);
    }


    //根据id返回对应控件的value值，并转换为float值
    function getFloat(id) {
        return parseFloat($(id).value);
    }

    //计算宝具伤害
    function calc() {
        //1.攻击力
        var attack = getFloat("txtAttack");

        //2.强化芙芙Atk
        var fufuAtk = getFloat("txtFufuAtk");

        //3.礼装Atk
        var cardAtk = getFloat("txtCardAtk");

        attack += fufuAtk + cardAtk;

        //4.宝具倍率(%)
        var treasureRate = getFloat("txtTreasureRate") / 100;

        //5.卡色
        var cardColor = getFloat("ddlCardColor");

        //6.职介克制
        var careerResist = getFloat("ddlCareerResist");

        //7.阵营克制
        var campResist = getFloat("ddlCampResist");

        //8.从者职介 
        var career = getFloat("ddlCareer");

        //9.宝具威力Buff(%)
        var treasurePowerBuff = getFloat("txtTreasurePowerBuff") / 100;

        //10.卡牌Buff(%)
        var cardBuff = getFloat("txtCardBuff") / 100;

        //11.攻击力Buff(%)
        var attackBuff = getFloat("txtAttackBuff") / 100;

        //12.敌方防御力Buff(%)
        var enemyDefenceBuff = getFloat("txtEnemyDefenceBuff") / 100;

        //13.特攻威力Buff(%)
        var specialAttackPowerBuff = getFloat("txtSpecialAttackPowerBuff") / 100;

        //14.敌方特防威力Buff(%)
        var specialDefencePowerBuff = getFloat("txtSpecialDefencePowerBuff") / 100;

        //15.固定伤害Buff
        var fixedDamageBuff = getFloat("txtFixedDamageBuff");

        //16.敌方固定减伤Buff
        var enemyFixedDamageReductionBuff = getFloat("txtEnemyFixedDamageReductionBuff");

        //17.宝具特攻(%)     
        var treasureSpecialAttack = getFloat("txtTreasureSpecialAttack") / 100;
        /*
            ATK×攻击补正(0.23)×[宝具倍率×卡牌伤害倍率×(1+卡牌BUFF)]×职阶补正×职阶相性补正×阵营相性补正×乱数补正×(1+攻击力BUFF—敌方防御力BUFF)×(1+特攻威力BUFF—敌方特防威力BUFF+宝具威力BUFF)×宝具特攻
            +(固定伤害BUFF—敌方固定伤害BUFF)
        */
        var resultMin = attack * 0.23 * [treasureRate * cardColor * (1 + cardBuff)] * career * careerResist * campResist * 0.9 * (1 + attackBuff - enemyDefenceBuff) * (1 + specialAttackPowerBuff - specialDefencePowerBuff + treasurePowerBuff) * treasureSpecialAttack + (fixedDamageBuff - enemyFixedDamageReductionBuff);
        resultMin = Math.floor(resultMin);

        var resultMax = attack * 0.23 * [treasureRate * cardColor * (1 + cardBuff)] * career * careerResist * campResist * 1.1 * (1 + attackBuff - enemyDefenceBuff) * (1 + specialAttackPowerBuff - specialDefencePowerBuff + treasurePowerBuff) * treasureSpecialAttack + (fixedDamageBuff - enemyFixedDamageReductionBuff);
        resultMax = Math.round(resultMax);

        alert("宝具伤害：" + resultMin + "~" + resultMax);
    }
</script>
